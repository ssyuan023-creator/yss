<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾å¥½çš„ç¬é—´ | ç…§ç‰‡å¢™</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --color-bg: #FFFAF0;
            --color-primary: #2C5282;
            --color-pink: #E88BA5;
            --color-text: #2D3748;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            margin: 0;
            padding-bottom: 50px;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .top-bar {
            background: rgba(255, 255, 255, 0.95);
            padding: 0.8rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .home-link { text-decoration: none; color: var(--color-primary); font-weight: bold; }

        /* ä¸Šä¼ åŒº */
        .upload-area {
            background: white;
            padding: 1rem;
            border-radius: 16px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            margin: 1.5rem auto;
            max-width: 700px; /* ç¨å¾®çª„ä¸€ç‚¹ */
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .input-style {
            padding: 8px 12px;
            border: 1px solid #E2E8F0;
            border-radius: 20px; /* åœ†æ¶¦ä¸€ç‚¹ */
            outline: none;
            font-size: 0.9rem;
            background: #F7FAFC;
        }

        /* === æ ¸å¿ƒå¸ƒå±€ä¿®æ”¹ï¼šGrid åŒåˆ—å¸ƒå±€ === */
        .photo-grid {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
            display: grid;
            /* ç”µè„‘ç«¯æ˜¾ç¤º2åˆ—ï¼Œå¹³æ¿2åˆ—ï¼Œæ‰‹æœº1åˆ— */
            grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
            gap: 25px;
        }
        @media (max-width: 500px) {
            .photo-grid { grid-template-columns: 1fr; }
        }

        /* å•ä¸ªå¡ç‰‡ */
        .photo-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
            position: relative;
            transition: transform 0.2s;
            height: 550px; /* å›ºå®šé«˜åº¦ï¼Œé˜²æ­¢é•¿çŸ­ä¸ä¸€ */
        }
        .photo-card:hover { transform: translateY(-3px); }

        /* ä¸ŠåŠéƒ¨åˆ†ï¼šå›¾ç‰‡åŒº (å  55% é«˜åº¦) */
        .card-image-area {
            height: 55%;
            background: #FFFAF0; 
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .card-image-area img {
            width: 100%;
            height: 100%;
            object-fit: contain; /* å®Œæ•´æ˜¾ç¤ºä¸è£åˆ‡ */
        }

        /* ä¸‹åŠéƒ¨åˆ†ï¼šè¯„è®ºåŒº (å  45% é«˜åº¦) */
        .card-chat-area {
            height: 45%;
            padding: 15px;
            display: flex;
            flex-direction: column;
            background: #fff;
            position: relative;
        }

        .chat-header {
            font-size: 0.8rem;
            color: #A0AEC0;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
        }

        /* æ»šåŠ¨åˆ—è¡¨ï¼šå¿…é¡»é™åˆ¶é«˜åº¦ï¼Œå¦åˆ™ä¼šæ’‘å¼€ */
        .bubble-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-right: 5px;
            margin-bottom: 8px;
        }

        /* æ°”æ³¡æ ·å¼ */
        .bubble-row { display: flex; flex-direction: column; max-width: 90%; }
        .bubble-row.mine { align-self: flex-end; align-items: flex-end; }
        .bubble-row.others { align-self: flex-start; align-items: flex-start; }

        .bubble-author { font-size: 0.7rem; color: #CBD5E0; margin-bottom: 2px; margin-left: 5px; }
        .bubble-row.mine .bubble-author { margin-right: 5px; }

        .bubble {
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            line-height: 1.4;
            word-wrap: break-word;
        }
        .bubble-row.others .bubble { background: #F0F4F8; color: #4A5568; border-bottom-left-radius: 2px; }
        .bubble-row.mine .bubble { background: #FFF5F7; color: #97266D; border-bottom-right-radius: 2px; }

        /* åº•éƒ¨è¾“å…¥æ¡† */
        .mini-input-group {
            display: flex;
            gap: 5px;
        }
        .mini-btn {
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex; 
            align-items: center; 
            justify-content: center;
        }

        /* === å¤åˆ»é¦–é¡µç²‰è‰²åˆ é™¤æŒ‰é’® === */
        .delete-btn-pink {
            position: absolute;
            top: 10px;
            right: 10px; /* æ”¾å³ä¸Šè§’ */
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid var(--color-pink);
            color: var(--color-pink);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.2s;
            opacity: 0.8;
        }
        .delete-btn-pink:hover {
            background: var(--color-pink);
            color: white;
            opacity: 1;
            transform: scale(1.1);
        }

        /* === é¦–é¡µåŒæ¬¾ï¼šä¿¡å°å¼¹çª—æ ·å¼ (å¿…é¡»åŠ ) === */
        .envelope-card {
            background: #fff;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .envelope-heart { font-size: 40px; margin-bottom: 10px; }
        .envelope-title { color: #2C5282; font-size: 1.2rem; margin-bottom: 10px; }
        .envelope-text { color: #718096; font-size: 0.95rem; margin-bottom: 20px; line-height: 1.6; }
        .cute-input {
            width: 80%;
            padding: 10px;
            border: 2px solid #E2E8F0;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1rem;
            outline: none;
        }
        .cute-input:focus { border-color: var(--color-pink); }
        .envelope-actions { display: flex; justify-content: center; gap: 15px; }
        .btn-cute {
            padding: 8px 25px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.1s;
        }
        .btn-confirm { background: var(--color-pink); color: white; }
        .btn-cancel { background: #EDF2F7; color: #718096; }
        .btn-cute:active { transform: scale(0.95); }

                /* === ç²’å­ç‰¹æ•ˆæ ·å¼ (æ¬è¿è‡ª index.html) === */
        .like-particle {
            position: fixed;
            pointer-events: none;
            font-size: 24px;
            animation: fly-away 1s ease-out forwards;
            z-index: 9999;
        }
        @keyframes fly-away {
            0% { transform: translate(0, 0) rotate(0deg) scale(1); opacity: 1; }
            100% { transform: translate(var(--tx), -100px) rotate(var(--rot)) scale(0); opacity: 0; }
        }

    </style>
</head>
<body>

    <div class="top-bar">
        <a href="index.html" class="home-link">â† è¿”å›é¦–é¡µ</a>
        <div style="font-weight:bold; color:var(--color-primary);">âœ¨ æ—¶å…‰ç›¸å†Œ</div>
    </div>

    <!-- ä¸Šä¼ åŒº -->
    <div class="upload-area">
        <button onclick="document.getElementById('photoInput').click()" style="background:#EDF2F7; color:#4A5568; border:none; padding:8px 15px; border-radius:20px; cursor:pointer; font-weight:500;">ğŸ“· é€‰å¼ ç…§ç‰‡</button>
        <input type="file" id="photoInput" accept="image/*" style="display:none" onchange="updateFileName()">
        <span id="fileName" style="font-size:0.8rem; color:#A0AEC0; max-width:80px; overflow:hidden; white-space:nowrap;"></span>
        
        <input type="text" id="uploaderName" class="input-style" placeholder="ä½ çš„åå­—" style="width:80px; text-align:center;">
        <input type="text" id="photoCaption" class="input-style" placeholder="è®°å½•è¿™ä¸€åˆ»..." style="flex:1; min-width:120px;">
        
        <button onclick="uploadPhoto()" id="uploadBtn" style="background:var(--color-primary); color:white; border:none; padding:8px 20px; border-radius:20px; cursor:pointer; font-weight:bold;">å‘å¸ƒ</button>
    </div>

    <!-- æ ¸å¿ƒï¼šåŒåˆ—å¡ç‰‡æµ -->
    <div class="photo-grid" id="photo-grid">
        <!-- JS å¡«å……å†…å®¹ -->
    </div>

    <script>
        // ================= é…ç½®åŒº =================
        const supabaseUrl = 'https://ewlqcfsnmdhvjbgpqbyp.supabase.co'; 
        const supabaseKey = 'sb_publishable_9p1JpA_jA5zUkZNBDzpTYQ_BCSSoyQQ'; 
        const _supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        const savedName = localStorage.getItem('userName') || '';
        if(savedName) document.getElementById('uploaderName').value = savedName;

        function updateFileName() {
            const file = document.getElementById('photoInput').files[0];
            if(file) document.getElementById('fileName').textContent = file.name;
        }

        // ä¸Šä¼ ç…§ç‰‡
        async function uploadPhoto() {
            const fileInput = document.getElementById('photoInput');
            const nameInput = document.getElementById('uploaderName');
            const captionInput = document.getElementById('photoCaption');
            const uploadBtn = document.getElementById('uploadBtn');

            if (fileInput.files.length === 0) return Swal.fire({title:'è¿˜æ²¡é€‰ç…§ç‰‡å‘¢', icon:'warning', toast:true, position:'top'});
            if (!nameInput.value.trim()) return Swal.fire({title:'è¯·å‘Šè¯‰æˆ‘ä»¬ä½ æ˜¯è°', icon:'warning', toast:true, position:'top'});

            localStorage.setItem('userName', nameInput.value.trim());

            try {
                uploadBtn.textContent = '...';
                uploadBtn.disabled = true;

                const file = fileInput.files[0];
                const fileName = `${Date.now()}_${Math.random().toString(36).substr(2)}.${file.name.split('.').pop()}`;

                const { error: upErr } = await _supabase.storage.from('photo-wall').upload(fileName, file);
                if (upErr) throw upErr;

                const { data: { publicUrl } } = _supabase.storage.from('photo-wall').getPublicUrl(fileName);

                const { error: dbErr } = await _supabase.from('photos').insert([{
                    image_url: publicUrl,
                    caption: captionInput.value,
                    author_name: nameInput.value.trim()
                }]);
                if (dbErr) throw dbErr;

                fileInput.value = '';
                captionInput.value = '';
                nameInput.value = ''; // å‘å¸ƒåæ¸…ç©ºåå­—ï¼Œé˜²æ­¢è¯¯ç”¨
                document.getElementById('fileName').textContent = '';
                loadPhotos();
                localStorage.removeItem('userName'); 

            

            } catch (err) {
                console.error(err);
                Swal.fire('å‘å¸ƒå¤±è´¥', err.message, 'error');
            } finally {
                uploadBtn.textContent = 'å‘å¸ƒ';
                uploadBtn.disabled = false;
            }
        }

        // åŠ è½½åˆ—è¡¨
        async function loadPhotos() {
            const grid = document.getElementById('photo-grid');
            
            const { data: photos, error } = await _supabase
                .from('photos')
                .select('*, comments(*)')
                .order('created_at', { ascending: false });

            if (error) { console.error(error); return; }

            if (!photos || photos.length === 0) {
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:4rem; color:#CBD5E0;">è¿˜æ²¡ç…§ç‰‡ï¼Œå¿«æ¥å é¢†å°é¢ï¼ğŸ“¸</div>';
                return;
            }

            grid.innerHTML = '';

            for (const photo of photos) {
                const comments = photo.comments || [];
                const dateStr = new Date(photo.created_at).toLocaleString('zh-CN', { month: 'numeric', day: 'numeric', hour: '2-digit', minute:'2-digit' });
                
                // ç•™è¨€HTMLæ„å»º
                let commentsHtml = '';
                // ä¸»äºº
                if (photo.caption) {
                    commentsHtml += `
                        <div class="bubble-row mine">
                            <span class="bubble-author">${escapeHtml(photo.author_name)} (å‘å¸ƒè€…)</span>
                            <div class="bubble">${escapeHtml(photo.caption)}</div>
                        </div>`;
                }
                // è®¿å®¢
                comments.forEach(c => {
                    commentsHtml += `
                        <div class="bubble-row others">
                            <span class="bubble-author">${escapeHtml(c.author_name)}</span>
                            <div class="bubble">${escapeHtml(c.content)}</div>
                        </div>`;
                });

                const card = document.createElement('div');
                card.className = 'photo-card';
                card.innerHTML = `
                    <button class="delete-btn-pink" onclick="deleteWithStyle(${photo.id})">Ã—</button>
                    
                    <div class="card-image-area">
                        <img src="${photo.image_url}" loading="lazy" onclick="window.open('${photo.image_url}')">
                    </div>
                    
                    <div class="card-chat-area">
                        <div class="chat-header">
                            <span>ğŸ“… ${dateStr}</span>
                            <span>@${escapeHtml(photo.author_name || 'ç¥ç§˜äºº')}</span>
                        </div>
                        
                        <div class="bubble-list" id="list-${photo.id}">
                            ${commentsHtml}
                        </div>
                        
                        <div class="mini-input-group">
                            <input type="text" id="cn-${photo.id}" class="input-style" placeholder="åå­—" style="width:60px; font-size:0.8rem; text-align:center;" value="${localStorage.getItem('userName')||''}">
                            <input type="text" id="cc-${photo.id}" class="input-style" placeholder="å›åº”ä¸€ä¸‹..." style="flex:1;">
                            <button class="mini-btn" onclick="addComment(${photo.id})">â¤</button>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            }
        }

             // æ·»åŠ è¯„è®º (å¸¦ç‰¹æ•ˆç‰ˆ)
        async function addComment(photoId) {
            const nameInput = document.getElementById(`cn-${photoId}`);
            const contentInput = document.getElementById(`cc-${photoId}`);
            const btn = document.querySelector(`#cc-${photoId} + button`); // è·å–ç‚¹å‡»çš„æŒ‰é’®ç”¨äºå®šä½ç‰¹æ•ˆ
            
            const name = nameInput.value.trim();
            const content = contentInput.value.trim();

            if (!name || !content) return Swal.fire({title:'åå­—å†…å®¹éƒ½è¦å¡«å“¦', toast:true, position:'center', timer:1500, showConfirmButton:false});
            
            // 1. è§¦å‘ç²’å­ç‰¹æ•ˆ (åœ¨æŒ‰é’®ä¸­å¿ƒç‚¸å¼€)
            if (btn) {
                const rect = btn.getBoundingClientRect();
                createCuteEffects(rect.left + rect.width/2, rect.top + rect.height/2);
            }

            try {
                const { error } = await _supabase.from('comments').insert([{ 
                    photo_id: photoId, 
                    content: content,
                    author_name: name 
                }]);
                if (error) throw error;

                // 2. ä¹è§‚æ›´æ–° UI
                const list = document.getElementById(`list-${photoId}`);
                const row = document.createElement('div');
                row.className = 'bubble-row others';
                row.innerHTML = `
                    <span class="bubble-author">${escapeHtml(name)}</span>
                    <div class="bubble">${escapeHtml(content)}</div>
                `;
                list.appendChild(row);
                list.scrollTop = list.scrollHeight;
                
                // 3. å‡ºç°å¯çˆ±çš„æˆåŠŸæç¤º (å¤åˆ» index.html)
                Swal.fire({
                    icon: 'success',
                    title: 'å›åº”å·²é€è¾¾ ğŸ“¨', // æ–‡æ¡ˆæ”¹å¾—åº”æ™¯ä¸€ç‚¹
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000,
                    background: '#FFFAF0', // ç±³è‰²èƒŒæ™¯
                    color: '#2C5282'       // æ·±è“æ–‡å­—
                });

                // 4. æ¸…ç©ºè¾“å…¥
                contentInput.value = '';
                nameInput.value = ''; 

            } catch (err) {
                console.error(err);
                Swal.fire('å‘é€å¤±è´¥', err.message, 'error');
            }
        }

          

   
             // === æ ¸å¿ƒï¼šå¯çˆ±çš„åˆ é™¤ç¡®è®¤å¼¹çª— (å·²ä¿®å¤ï¼šæ¯æ¬¡æ‰“å¼€æ¸…ç©ºå¯†ç ) ===
        function deleteWithStyle(photoId) {
            Swal.fire({
                title: '',
                width: 500,
                padding: 0,
                background: 'transparent',
                showConfirmButton: false,
                html: `
                    <div class="envelope-card">
                        <div class="envelope-heart">ğŸ’Œ</div>
                        <h2 class="envelope-title">éªŒè¯èº«ä»½</h2>
                        <p class="envelope-text">åªæœ‰yssæ‰çŸ¥é“çš„ç§˜å¯†å£ä»¤...<br>è¯·è¾“å…¥å¯†é’¥åˆ é™¤ç…§ç‰‡ï¼š</p>
                        
                        <!-- ä¿®æ”¹ç‚¹1ï¼šåŠ äº† autocomplete="new-password" é˜²æ­¢æµè§ˆå™¨è‡ªåŠ¨å¡«å…… -->
                        <input type="password" id="secret-key" class="cute-input" placeholder="Password" 
                               autocomplete="new-password" readonly onfocus="this.removeAttribute('readonly');">
                               
                        <div class="envelope-actions">
                            <button onclick="checkKeyAndDel(${photoId})" class="btn-cute btn-confirm">ç¡®è®¤åˆ é™¤</button>
                            <button onclick="Swal.close()" class="btn-cute btn-cancel">å–æ¶ˆ</button>
                        </div>
                    </div>
                `,
                didOpen: () => {
                    const input = document.getElementById('secret-key');
                    if(input) {
                        // ä¿®æ”¹ç‚¹2ï¼šå¼ºåˆ¶æ¸…ç©ºè¾“å…¥æ¡†çš„å€¼
                        input.value = ''; 
                        
                        // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹å†èšç„¦ï¼Œæœ‰æ—¶å€™æµè§ˆå™¨ä¼šåœ¨èšç„¦ç¬é—´å¡«å……
                        setTimeout(() => {
                            input.focus();
                            // å†æ¬¡æ¸…ç©ºï¼ŒåŒé‡ä¿é™©
                            input.value = ''; 
                        }, 100);

                        input.addEventListener('keyup', (e) => {
                            if (e.key === 'Enter') checkKeyAndDel(photoId);
                        });
                    }
                }
            });
        }


        // éªŒè¯åˆ é™¤é€»è¾‘
        window.checkKeyAndDel = async function(id) {
            const input = document.getElementById('secret-key');
            if (input.value === 'ssyuan023') {
                  input.value = '';  // å¯†ç é”™è¯¯ï¼šç«‹åˆ»æ¸…ç©ºè¾“å…¥æ¡†
                try {
                    const { error } = await _supabase.from('photos').delete().eq('id', id);
                    if (error) throw error;
                    Swal.close();
                    Swal.fire({ icon: 'success', title: 'åˆ é™¤æˆåŠŸ âœ¨', toast: true, position: 'top', timer: 1500, showConfirmButton: false });
                    loadPhotos();
                } catch (err) {
                    Swal.showValidationMessage('åˆ é™¤å¤±è´¥: ' + err.message);
                }
            } else {
                Swal.showValidationMessage('å¯†é’¥ä¸å¯¹å“¦ï¼Œè¯·é‡æ–°è¾“å…¥');
            }
        }

        function escapeHtml(text) {
            if(!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        loadPhotos();

                // === å¯çˆ±çš„ç²’å­ç‰¹æ•ˆå‡½æ•° ===
        function createCuteEffects(x, y) {
            const emojis = ['ğŸ’¬', 'âœ¨', 'ğŸŒ¸', 'ğŸ’–', 'ğŸ°', 'ğŸ“¨']; // æ”¹æˆäº†å’Œè¯„è®ºç›¸å…³çš„è¡¨æƒ…
            const particleCount = 8; 

            for (let i = 0; i < particleCount; i++) {
                const el = document.createElement('div');
                el.innerText = emojis[Math.floor(Math.random() * emojis.length)];
                el.className = 'like-particle';
                
                // éšæœºä½ç½®åç§»
                const randomX = (Math.random() - 0.5) * 80; 
                const randomRot = (Math.random() - 0.5) * 60; 
                
                el.style.left = `${x}px`;
                el.style.top = `${y}px`;
                el.style.setProperty('--tx', `${randomX}px`);
                el.style.setProperty('--rot', `${randomRot}deg`);
                
                document.body.appendChild(el);

                setTimeout(() => el.remove(), 1000);
            }
        }

    </script>
</body>
</html>
